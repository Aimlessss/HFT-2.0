<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      height: 100vh;
      background: #fff7f0;
      padding-top: 60px;
    }

    h1 {
      color: #333;
    }

    .btn {
      background-color: #ff7b00;
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
      margin: 10px;
    }

    .btn:hover {
      background-color: #e86d00;
    }

    #ordersTable {
      margin-top: 30px;
      border-collapse: collapse;
      width: 80%;
      max-width: 600px;
    }

    #ordersTable th, #ordersTable td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    #ordersTable th {
      background-color: #ff7b00;
      color: white;
    }

    #ordersTable td {
      background-color: #fff;
    }

    #ordersTable tr:nth-child(even) {
      background-color: #f9f9f9;
    }
  </style>

  <!-- Socket.IO Client -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

</head>
<body>
  <h1>HFT Dashboard</h1>
  <div>
    <button id="execute" class="btn">Execute Strategy</button>
    <button id="fetchOrders" class="btn">Fetch Orders</button>
  </div>

  <table id="ordersTable" style="display:none;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Symbol</th>
        <th>Side</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="ordersBody"></tbody>
  </table>

<script>
  const executeBtn = document.getElementById("execute");
  console.log('execute button found?', executeBtn);
  const fetchBtn = document.getElementById("fetchOrders");
  const table = document.getElementById("ordersTable");
  const tbody = document.getElementById("ordersBody");

  // Connect to backend Socket.IO server
  const socket = io("http://localhost:5000");

  socket.on("connect", () => {
    console.log("ðŸŸ¢ Connected to trade server:", socket.id);
  });

  // Listen for new orders
  socket.on("newOrder", (order) => {
    console.log("ðŸ“¦ New order received:", order);

    // Show table if hidden
    table.style.display = "table";

    // Add order to table
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${order.order_id || "N/A"}</td>
      <td>${order.symbol}</td>
      <td>${order.type}</td>
      <td>${order.quantity}</td>
      <td>${order.price || "Market"}</td>
      <td>Placed</td>
    `;
    tbody.prepend(row); // Add to top of table
  });

  // Execute Trade
  executeBtn.addEventListener("click", async () => {
    executeBtn.disabled = true;
    executeBtn.textContent = "Checking market...";

    try {
      const res = await fetch("http://localhost:5000/trade/execute", {
        method: "POST",
        credentials: "include"
      });
      const data = await res.json();

      if (data.status === "closed") {
        executeBtn.textContent = data.message;
        executeBtn.style.backgroundColor = "#888";
      } else if (data.status === "open") {
        executeBtn.textContent = "Trade executed âœ…";
        executeBtn.style.backgroundColor = "#28a745";
      } else {
        executeBtn.textContent = "Error! Check console";
        console.error(data.message);
      }
    } catch (err) {
      executeBtn.textContent = `${err}`;
      console.error("Error occurred:", err);
    } finally {
      setTimeout(() => {
        executeBtn.disabled = false;
        executeBtn.textContent = "Execute Strategy";
        executeBtn.style.backgroundColor = "#ff7b00";
      }, 5000);
    }
  });
  const holdingsTable = document.getElementById("holdingsTable");
  const holdingsBody = document.getElementById("holdingsBody");

  async function fetchHoldings() {
    try {
      const res = await fetch("http://localhost:5000/holdings", { credentials: "include" });
      const data = await res.json();

      holdingsBody.innerHTML = "";
      if (data.holdings && data.holdings.length > 0) {
        data.holdings.forEach(h => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${h.tradingsymbol}</td>
            <td>${h.exchange}</td>
            <td>${h.pnl}</td>
          `;
          holdingsBody.appendChild(row);
        });
      }
    } catch (err) {
      console.error("Error fetching holdings:", err);
    }
  }

  // Fetch every 10 seconds
  setInterval(fetchHoldings, 10000);

</script>
</body>
</html>
